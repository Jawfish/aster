#!/usr/bin/env bash
#
# aster - Cross-language lint rules
#
# Usage:
#   aster lint <target>       Run all checks on target directory
#   aster diff [base]         Run all checks only on changed lines (vs main or base)
#   aster staged              Run all checks only on staged changes
#   aster test                Test the rules themselves

set -euo pipefail

ASTER_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

cmd_lint() {
    local target="${1:-.}"
    local exit_code=0

    echo "=== Running ast-grep rules ==="
    ast-grep scan --config "$ASTER_ROOT/sgconfig.yml" "$target" || exit_code=1

    echo ""
    echo "=== Checking test naming conventions ==="
    "$ASTER_ROOT/scripts/check-sut-names.sh" "$target" "$target" || exit_code=1

    exit $exit_code
}

cmd_diff() {
    local base="${1:-main}"
    "$ASTER_ROOT/scripts/scan-diff.sh" "$base"
}

cmd_staged() {
    "$ASTER_ROOT/scripts/scan-diff.sh" --staged
}

cmd_test() {
    ast-grep test --config "$ASTER_ROOT/sgconfig.yml" --skip-snapshot-tests
}

cmd_help() {
    cat <<EOF
aster - Cross-language lint rules

Usage:
    aster lint <target>        Run all checks on target directory (default)
    aster diff [base]          Run ast-grep rules on changed lines vs base (default: main)
    aster staged               Run ast-grep rules on staged changes
    aster test                 Test the rules themselves
    aster help                 Show this help

Note: diff/staged run ast-grep rules only. Full lint also includes SUT name detection
which requires cross-file analysis.

Examples:
    aster lint ~/code/myproject     # Full lint on directory
    aster lint .                    # Full lint on current directory
    aster diff                      # Check only changes vs main
    aster diff origin/develop       # Check only changes vs develop
    aster staged                    # Check only staged changes (pre-commit)
    aster test                      # Verify rules work
EOF
}

case "${1:-lint}" in
    lint)        shift || true; cmd_lint "$@" ;;
    diff)        shift; cmd_diff "$@" ;;
    staged)      cmd_staged ;;
    test)        cmd_test ;;
    help|--help|-h) cmd_help ;;
    *)           cmd_lint "$@" ;;
esac
